{% extends 'base_auth.html' %}
{% load profile_tags %}

{% block title %}Inicio - Twitter Clone{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto flex flex-col md:flex-row bg-black text-white">
    <!-- Columna izquierda (menú lateral) -->
    <div class="hidden md:block md:w-1/5 md:pr-4">
        <div class="sticky top-4">
            <nav class="space-y-1">
                <!-- Menú principal -->
                <a href="{% url 'home' %}" class="flex items-center justify-start p-3 rounded-full hover:bg-gray-800 w-fit">
                    <svg class="w-8 h-8 text-white" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                </a>
                <a href="{% url 'home' %}" class="flex items-center space-x-4 p-3 rounded-full hover:bg-gray-800 w-fit">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 1.696L.622 8.807l1.06 1.696L3 9.679V19.5C3 20.881 4.119 22 5.5 22h13c1.381 0 2.5-1.119 2.5-2.5V9.679l1.318.824 1.06-1.696L12 1.696zM12 16.5c-1.933 0-3.5-1.567-3.5-3.5s1.567-3.5 3.5-3.5 3.5 1.567 3.5 3.5-1.567 3.5-3.5 3.5z"/>
                    </svg>
                    <span class="text-xl font-bold">Inicio</span>
                </a>

                <a href="#" class="flex items-center space-x-4 p-3 rounded-full hover:bg-gray-800 w-fit">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"/>
                    </svg>
                    <span class="text-xl">Explorar</span>
                </a>

                <a href="#" class="flex items-center space-x-4 p-3 rounded-full hover:bg-gray-800 w-fit">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19.993 9.042C19.48 5.017 16.054 2 11.996 2s-7.49 3.021-7.999 7.051L2.866 18H7.1c.463 2.282 2.481 4 4.9 4s4.437-1.718 4.9-4h4.236l-1.143-8.958zM12 20c-1.306 0-2.417-.835-2.829-2h5.658c-.412 1.165-1.523 2-2.829 2zm-6.866-4l.847-6.698C6.364 6.272 8.941 4 11.996 4s5.627 2.268 6.013 5.295L18.864 16H5.134z"/>
                    </svg>
                    <span class="text-xl">Notificaciones</span>
                </a>

                <a href="#" class="flex items-center space-x-4 p-3 rounded-full hover:bg-gray-800 w-fit">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M1.998 5.5c0-1.381 1.119-2.5 2.5-2.5h15c1.381 0 2.5 1.119 2.5 2.5v13c0 1.381-1.119 2.5-2.5 2.5h-15c-1.381 0-2.5-1.119-2.5-2.5v-13zm2.5-.5c-.276 0-.5.224-.5.5v2.764l8 3.638 8-3.636V5.5c0-.276-.224-.5-.5-.5h-15zm15.5 5.463l-8 3.636-8-3.638V18.5c0 .276.224.5.5.5h15c.276 0 .5-.224.5-.5v-8.037z"/>
                    </svg>
                    <span class="text-xl">Mensajes</span>
                </a>

                <a href="#" class="flex items-center space-x-4 p-3 rounded-full hover:bg-gray-800 w-fit">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 4.5C3 3.12 4.12 2 5.5 2h13C19.88 2 21 3.12 21 4.5v15c0 1.38-1.12 2.5-2.5 2.5h-13C4.12 22 3 20.88 3 19.5v-15zM5.5 5c-.28 0-.5.22-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.28-.22-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z"/>
                    </svg>
                    <span class="text-xl">Grok</span>
                </a>

                <a href="#" class="flex items-center space-x-4 p-3 rounded-full hover:bg-gray-800 w-fit">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7.501 19.917L7.471 21H.472l.029-1.027c.184-6.618 3.736-8.977 7-8.977.963 0 1.95.212 2.87.672-.444.478-.851 1.03-1.212 1.656-.507-.204-1.054-.329-1.658-.329-2.767 0-4.57 2.223-4.938 6.004H7.56c-.023.302-.05.599-.059.917zm15.998.056L23.528 21H9.472l.029-1.027c.184-6.618 3.736-8.977 7-8.977s6.816 2.358 7 8.977zM21.437 19c-.367-3.781-2.17-6.004-4.938-6.004s-4.57 2.223-4.938 6.004h9.875zm-4.938-9c-.799 0-1.527-.279-2.116-.73-.836-.64-1.384-1.638-1.384-2.77 0-1.93 1.567-3.5 3.5-3.5s3.5 1.57 3.5 3.5c0 1.132-.548 2.13-1.384 2.77-.589.451-1.317.73-2.116.73zm-1.5-3.5c0 .827.673 1.5 1.5 1.5s1.5-.673 1.5-1.5-.673-1.5-1.5-1.5-1.5.673-1.5 1.5zM7.5 3C9.433 3 11 4.57 11 6.5S9.433 10 7.5 10 4 8.43 4 6.5 5.567 3 7.5 3zm0 2c-.827 0-1.5.673-1.5 1.5S6.673 8 7.5 8 9 7.327 9 6.5 8.327 5 7.5 5z"/>
                    </svg>
                    <span class="text-xl">Comunidades</span>
                </a>

                <a href="{% url 'profile' username=request.user.username %}" class="flex items-center space-x-4 p-3 rounded-full hover:bg-gray-800 w-fit">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M5.651 19h12.698c-.337-1.8-1.023-3.21-1.945-4.19C15.318 13.65 13.838 13 12 13s-3.317.65-4.404 1.81c-.922.98-1.608 2.39-1.945 4.19zm.486-5.56C7.627 11.85 9.648 11 12 11s4.373.85 5.863 2.44c1.477 1.58 2.366 3.8 2.632 6.46l.11 1.1H3.395l.11-1.1c.266-2.66 1.155-4.88 2.632-6.46zM12 4c-1.105 0-2 .9-2 2s.895 2 2 2 2-.9 2-2-.895-2-2-2zM8 6c0-2.21 1.791-4 4-4s4 1.79 4 4-1.791 4-4 4-4-1.79-4-4z"/>
                    </svg>
                    <span class="text-xl">Perfil</span>
                </a>

                <a href="#" class="flex items-center space-x-4 p-3 rounded-full hover:bg-gray-800 w-fit">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3.75 12c0-4.56 3.69-8.25 8.25-8.25 1.72 0 3.35.53 4.7 1.52l-2.46 2.47c-.28.27-.44.65-.44 1.06 0 .83.67 1.5 1.5 1.5h4.5c.41 0 .75-.34.75-.75V3.75c0-.83-.67-1.5-1.5-1.5-.41 0-.79.16-1.06.44l-2.47 2.46C16.47 3.53 14.72 3 13 3 7.48 3 3 7.48 3 12s4.48 9 9 9c1.72 0 3.35-.53 4.7-1.52l-2.46-2.47c-.28-.27-.44-.65-.44-1.06 0-.83.67-1.5 1.5-1.5h4.5c.41 0 .75.34.75.75v4.5c0 .83-.67 1.5-1.5 1.5-.41 0-.79-.16-1.06-.44l-2.47-2.46C16.47 20.47 14.72 21 13 21c-4.56 0-8.25-3.69-8.25-8.25z"/>
                    </svg>
                    <span class="text-xl">Más opciones</span>
                </a>

                <!-- Botón Postear -->
                <div class="mt-4">
                    <a href="#" class="bg-twitter-blue text-white rounded-full p-4 w-full flex justify-center items-center font-bold hover:bg-blue-600 transition text-lg">
                        Postear
                    </a>
                </div>

                <!-- Bloque de usuario -->
                <div class="relative mt-6">
                    <button id="avatarButton" class="flex items-center justify-between w-full p-2 hover:bg-gray-800 rounded-full focus:outline-none">
                        <div class="flex items-center space-x-3">
                            {% if user.profile_picture and user.profile_picture.name %}
                                <img src="{{ user.profile_picture.url }}" alt="Avatar" class="w-10 h-10 rounded-full">
                            {% else %}
                                <img src="https://pbs.twimg.com/profile_images/1308769664240160770/AfgzWVE7_400x400.jpg" alt="Avatar" class="w-10 h-10 rounded-full">
                            {% endif %}
                            <div class="text-left hidden md:block">
                                <div class="font-bold text-white text-sm">{{ user.full_name|default:user.username }}</div>
                                <div class="text-gray-400 text-sm">@{{ user.username }}</div>
                            </div>
                        </div>
                        <!-- Flecha de despliegue -->
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.08 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>

                    <!-- Dropdown -->
                    <div id="dropdownMenu" class="hidden absolute bottom-14 w-full bg-white rounded-xl shadow-lg py-2 text-black z-50">
                        <form action="{% url 'logout' %}" method="post" class="block w-full text-left">
                            {% csrf_token %}
                            <button type="submit" class="w-full px-4 py-2 hover:bg-gray-200">
                                Cerrar sesión
                            </button>
                        </form>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- Columna central (feed) -->
    <div class="w-full md:w-2/5 border-x border-gray-700 min-h-screen">
        <!-- Encabezado sticky -->
        <div class="sticky top-0 z-10 bg-black bg-opacity-90 backdrop-blur-sm p-4 border-b border-gray-700">
            <h1 class="text-xl font-bold">Para ti</h1>
        </div>

    <!-- Formulario para tweet -->
    <form id="tweet-form" method="POST" action="/tweets/api/tweets/" enctype="multipart/form-data" class="border-b border-gray-700 p-4">
        {% csrf_token %}
        <div class="flex space-x-3">
            <!-- Avatar del usuario -->
            <div class="flex-shrink-0">
                {% if user.profile_picture and user.profile_picture.name %}
                    <img src="{{ user.profile_picture.url }}" alt="Avatar" class="w-12 h-12 rounded-full object-cover">
                {% else %}
                    <img src="https://pbs.twimg.com/profile_images/1308769664240160770/AfgzWVE7_400x400.jpg" alt="Avatar" class="w-12 h-12 rounded-full object-cover">
                {% endif %}
            </div>

            <div class="flex-1">
                <!-- Textarea para el tweet -->
                <textarea id="tweet-text"
                          name="content"
                          class="w-full bg-black text-white text-xl placeholder-gray-500 resize-none outline-none min-h-[100px]"
                          placeholder="¿Qué está pasando?"
                          oninput="autoResize(this)"></textarea>

                <!-- Previsualización de imágenes -->
                <div id="image-preview" class="mt-3 grid grid-cols-2 gap-2 hidden"></div>

                <div class="flex justify-between items-center pt-3 border-t border-gray-700 mt-2">
                    <div class="flex space-x-1 text-twitter-blue">
                        <!-- Botón para subir imágenes -->
                        <button type="button"
                                class="p-2 rounded-full hover:bg-blue-900 hover:bg-opacity-20 transition-colors duration-200"
                                onclick="document.getElementById('media-upload').click()"
                                title="Media">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M3 5.5C3 4.119 4.119 3 5.5 3h13C19.881 3 21 4.119 21 5.5v13c0 1.381-1.119 2.5-2.5 2.5h-13C4.119 21 3 19.881 3 18.5v-13zM5.5 5c-.276 0-.5.224-.5.5v9.086l3-3 3 3 5-5 3 3V5.5c0-.276-.224-.5-.5-.5h-13zM19 15.414l-3-3-5 5-3-3-3 3V18.5c0 .276.224.5.5.5h13c.276 0 .5-.224.5-.5v-3.086zM9.75 7C8.784 7 8 7.784 8 8.75s.784 1.75 1.75 1.75 1.75-.784 1.75-1.75S10.716 7 9.75 7z"/>
                            </svg>
                            <input id="media-upload" name="media" type="file" accept="image/*,video/*" class="hidden" multiple>
                        </button>

                        <!-- Botón de emojis -->
                        <button type="button"
                                class="p-2 rounded-full hover:bg-blue-900 hover:bg-opacity-20 transition-colors duration-200"
                                onclick="toggleEmojiPicker()"
                                title="Emoji">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zM8.5 8c.828 0 1.5.896 1.5 2s-.672 2-1.5 2S7 11.104 7 10s.672-2 1.5-2zm7 0c.828 0 1.5.896 1.5 2s-.672 2-1.5 2-1.5-.896-1.5-2 .672-2 1.5-2zm-7.444 7.005c-.35.366-.873.58-1.456.58C5.03 15.585 3 13.722 3 11.5S5.03 7.415 7.6 7.415c2.772 0 4.9 2.351 4.9 4.585 0 .688-.177 1.333-.485 1.895-.66-.33-1.485-.5-2.515-.5-1.198 0-2.218.368-3.046.995z"/>
                            </svg>
                        </button>

                        <!-- Picker de emojis -->
                        <div id="emoji-picker" class="hidden absolute z-10 mt-10 bg-gray-800 rounded-lg shadow-lg p-2 w-64 h-64 overflow-y-auto grid grid-cols-6 gap-2">
                            <!-- Aquí van los emojis -->
                        </div>
                    </div>

                    <!-- Botón submit -->
                    <button id="tweet-submit" type="submit"
                            class="bg-twitter-blue text-white px-4 py-1.5 rounded-full font-bold hover:bg-blue-600 disabled:opacity-50 disabled:hover:bg-twitter-blue transition-colors duration-200">
                        Postear
                    </button>
                </div>
            </div>
        </div>
    </form>


        <!-- Lista de posts -->
        <div class="divide-y divide-gray-700">
            <!-- Post de Elon Musk -->
            <div class="p-4 hover:bg-gray-900 transition duration-200">
                <div class="flex space-x-3">
                    <img src="https://pbs.twimg.com/profile_images/1683325380441128960/yRsRRjGO_400x400.jpg"
                         alt="Avatar"
                         class="w-12 h-12 rounded-full">
                    <div class="flex-1">
                        <div class="flex items-center space-x-1">
                            <span class="font-bold hover:underline">Elon Musk</span>
                            <span class="text-gray-500">@elonmusk</span>
                            <span class="text-gray-500">·</span>
                            <span class="text-gray-500">48min</span>
                        </div>
                        <p class="mt-1 text-white">Exciting developments at SpaceX today!</p>
                    </div>
                </div>
            </div>

            <!-- Post de Joe Biden -->
            <div class="p-4 hover:bg-gray-900 transition duration-200">
                <div class="flex space-x-3">
                    <img src="https://pbs.twimg.com/profile_images/1308769664240160770/AfgzWVE7_400x400.jpg"
                         alt="Avatar"
                         class="w-12 h-12 rounded-full">
                    <div class="flex-1">
                        <div class="flex items-center space-x-1">
                            <span class="font-bold hover:underline">Joe Biden</span>
                            <span class="text-gray-500">@JoeBiden</span>
                        </div>
                        <p class="mt-1 text-white">No one is above the law.</p>

                        <!-- Contexto adicional -->
                        <div class="mt-3 p-3 bg-gray-800 rounded-lg">
                            <div class="text-sm text-gray-400 mb-1">Readers added context</div>
                            <p class="text-sm text-gray-300">On December 1, 2024, President Joe Biden pardoned his son, Hunter Biden, for crimes covering nearly 11 years of "offenses against the United States which he has committed or may have committed or taken part in during the period from January 1, 2014 through December 1, 2024."</p>
                            <a href="#" class="text-sm text-twitter-blue hover:underline">whitehouse.gov/briefing-room/...</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Columna derecha (sugerencias) -->
    <div class="hidden md:block md:w-2/5 md:pl-4">
        <div class="sticky top-4 space-y-4">
            <!-- Barra de búsqueda -->
            <div class="relative">
                <input type="text"
                       placeholder="Buscar"
                       class="w-full bg-gray-800 rounded-full py-3 px-4 pl-10 focus:bg-gray-700 focus:ring-1 focus:ring-twitter-blue focus:outline-none text-white">
                <div class="absolute left-3 top-3 text-gray-500">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M10.25 3.75c-3.59 0-6.5 2.91-6.5 6.5s2.91 6.5 6.5 6.5c1.795 0 3.419-.726 4.596-1.904 1.178-1.177 1.904-2.801 1.904-4.596 0-3.59-2.91-6.5-6.5-6.5zm-8.5 6.5c0-4.694 3.806-8.5 8.5-8.5s8.5 3.806 8.5 8.5c0 1.986-.682 3.815-1.824 5.262l4.781 4.781-1.414 1.414-4.781-4.781c-1.447 1.142-3.276 1.824-5.262 1.824-4.694 0-8.5-3.806-8.5-8.5z"/>
                    </svg>
                </div>
            </div>

            <!-- Suscripción a Premium -->
            <div class="bg-gray-800 rounded-2xl p-4">
                <h2 class="text-xl font-bold mb-2">Suscríbete a Premium</h2>
                <p class="mb-3 text-gray-300">Suscríbete para desbloquear nuevas funciones y, si eres elegible, recibir un pago de cuota de ingresos.</p>
                <button class="bg-white text-black px-4 py-2 rounded-full font-bold hover:bg-gray-200">
                    Suscribirse
                </button>
            </div>

            <!-- En directo -->
            <div class="bg-gray-800 rounded-2xl">
                <h2 class="p-4 text-xl font-bold">En directo en X</h2>
                <div class="p-4 border-t border-gray-700 hover:bg-gray-700">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold">ABC Digital es anfitrión</p>
                            <p class="text-white">Cardinal Deportivo - EN VIVO</p>
                        </div>
                        <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">+514</span>
                    </div>
                </div>
            </div>

            <!-- A quién seguir -->
            <div class="bg-gray-800 rounded-2xl">
                <h2 class="p-4 text-xl font-bold">A quién seguir</h2>

                {% for user in suggested_users %}
                <div class="p-4 border-t border-gray-700 hover:bg-gray-700 flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        {% if user.profile_picture and user.profile_picture.name %}
                        <img src="{{ user.profile_picture.url }}" alt="Avatar" class="w-12 h-12 rounded-full object-cover">
                        {% else %}
                        <img src="https://pbs.twimg.com/profile_images/1308769664240160770/AfgzWVE7_400x400.jpg" alt="Avatar" class="w-12 h-12 rounded-full object-cover">
                        {% endif %}
                        <div class="flex flex-col">
                            <span class="font-bold">{{ user.full_name }}</span>
                            <span class="text-sm text-gray-400">@{{ user.username }}</span>
                        </div>
                    </div>
                    <form method="POST" action="{% url 'follow_user' user.username %}">
                        {% csrf_token %}
                        <button type="submit" class="bg-white text-black font-bold py-1 px-4 rounded-full hover:bg-gray-300 transition">
                            Seguir
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>


            <!-- Tendencias -->
            <div class="bg-gray-800 rounded-2xl">
                <h2 class="p-4 text-xl font-bold">Qué está pasando</h2>
                <div class="divide-y divide-gray-700">
                    <a href="#" class="block p-4 hover:bg-gray-700">
                        <p class="text-sm text-gray-400">Tendencia en Paraguay</p>
                        <p class="font-bold text-white">URGENTE</p>
                        <p class="text-sm text-gray-400">137 mil publicaciones</p>
                    </a>
                    <a href="#" class="block p-4 hover:bg-gray-700">
                        <p class="text-sm text-gray-400">Política - Tendencia</p>
                        <p class="font-bold text-white">#Vaticano</p>
                        <p class="text-sm text-gray-400">11.5K posts</p>
                    </a>
                </div>
            </div>

            <!-- Footer -->
            <div class="text-xs text-gray-500 p-4">
                <div class="flex flex-wrap gap-2">
                    <a href="#" class="hover:underline">Términos de servicio</a>
                    <a href="#" class="hover:underline">Política de privacidad</a>
                    <a href="#" class="hover:underline">Política de cookies</a>
                </div>
                <p class="mt-2">© 2025 Twitter Clone</p>
            </div>
        </div>
    </div>
</div>

<!-- Botón flotante para móvil -->
<div class="fixed bottom-6 right-6 md:hidden">
    <a href="#" class="bg-twitter-blue text-white rounded-full p-4 shadow-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
    </a>
</div>


<!-- Incluir Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js" type="module"></script>

<script>
// Autoajustar altura del textarea
function autoResize(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';

    // Habilitar/deshabilitar botón de postear
    const button = document.getElementById('tweet-submit');
    button.disabled = textarea.value.trim() === '';
    button.classList.toggle('opacity-50', button.disabled);
}

document.getElementById('tweet-form').addEventListener('submit', function(event) {
    let textarea = document.getElementById('tweet-text');
    let content = textarea.value.trim();

    // Transformar el contenido a formato Quill JSON
    let quillFormatted = JSON.stringify({
        ops: [{ insert: content + '\n' }]
    });

    // Reemplazar el contenido original del textarea
    textarea.value = quillFormatted;
});

// Array para almacenar las imágenes cargadas
let uploadedImages = [];

// Mostrar/ocultar emoji picker
function toggleEmojiPicker() {
    const picker = document.getElementById('emoji-picker');
    picker.classList.toggle('hidden');

    if (picker.childElementCount === 0) {
        const emojis = ["😀", "😂", "😍", "😭", "😎", "😡", "👍", "🎉", "❤️", "🔥", "👀", "🥳"];
        emojis.forEach(emoji => {
            const button = document.createElement('button');
            button.className = 'text-2xl p-2 hover:bg-gray-700 rounded';
            button.textContent = emoji;
            button.onclick = () => insertEmoji(emoji);
            picker.appendChild(button);
        });
    }
}

// Insertar emoji en el textarea
function insertEmoji(emoji) {
    const textarea = document.getElementById('tweet-text');
    const startPos = textarea.selectionStart;
    const endPos = textarea.selectionEnd;
    const text = textarea.value;

    textarea.value = text.substring(0, startPos) + emoji + text.substring(endPos);
    textarea.focus();
    textarea.selectionStart = startPos + emoji.length;
    textarea.selectionEnd = startPos + emoji.length;

    autoResize(textarea);
}

// Función para mostrar imágenes cargadas
function displayUploadedImages(files) {
    const previewContainer = document.createElement('div');
    previewContainer.id = 'image-preview';
    previewContainer.className = 'grid grid-cols-2 gap-2 mt-2';

    Array.from(files).forEach((file, index) => {
        if (file.type.match('image.*')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'relative';

                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'w-full h-32 object-cover rounded-lg';

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm hover:bg-red-600';
                deleteBtn.onclick = () => removeImage(index);

                previewDiv.appendChild(img);
                previewDiv.appendChild(deleteBtn);
                previewContainer.appendChild(previewDiv);
            };
            reader.readAsDataURL(file);
        }
    });

    // Eliminar contenedor previo si existe
    const existingPreview = document.getElementById('image-preview');
    if (existingPreview) {
        existingPreview.remove();
    }

    // Mostrar el contenedor si hay imágenes
    if (files.length > 0) {
        previewContainer.classList.remove('hidden');
        document.getElementById('tweet-text').after(previewContainer);
    }

    // Guardar archivos en array
    uploadedImages = Array.from(files);
}

// Función para eliminar imagen
function removeImage(index) {
    uploadedImages.splice(index, 1);

    // Actualizar input de archivos
    const dataTransfer = new DataTransfer();
    uploadedImages.forEach(file => dataTransfer.items.add(file));
    document.getElementById('media-upload').files = dataTransfer.files;

    // Volver a mostrar las imágenes restantes
    displayUploadedImages(uploadedImages);

    // Ocultar contenedor si no hay imágenes
    if (uploadedImages.length === 0) {
        document.getElementById('image-preview').classList.add('hidden');
    }
}

// Manejar subida de imágenes
document.getElementById('media-upload').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        displayUploadedImages(e.target.files);
    }
});

// Función para publicar el tweet
document.getElementById('tweet-submit').addEventListener('click', async function() {
    const content = document.getElementById('tweet-text').value;
    const mediaFiles = document.getElementById('media-upload').files;

    try {
        const response = await postTweet(content, mediaFiles);
        if (response.ok) {
            // Limpiar después de publicar
            document.getElementById('tweet-text').value = '';
            document.getElementById('media-upload').value = '';
            const preview = document.getElementById('image-preview');
            if (preview) preview.remove();
            uploadedImages = [];
            autoResize(document.getElementById('tweet-text'));
        } else {
            console.error('Error al publicar tweet');
        }
    } catch (error) {
        console.error('Error:', error);
    }
});

// Función para subir el tweet a la API
async function postTweet(content, mediaFiles) {
    const formData = new FormData();
    formData.append('content', content);

    // Agregar archivos multimedia si existen
    if (mediaFiles.length > 0) {
        for (let i = 0; i < mediaFiles.length; i++) {
            formData.append('media', mediaFiles[i]);
        }
    }

    return await fetch('/tweets/api/tweets/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: formData
    });
}

// Función auxiliar para obtener cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Inicializar textarea al cargar
document.addEventListener('DOMContentLoaded', function() {
    autoResize(document.getElementById('tweet-text'));
});
</script>
{% endblock %}